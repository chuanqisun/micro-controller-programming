<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Tool</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      * {
        box-sizing: border-box;
      }
      input,
      button {
        padding: 0.25rem 0.5rem;
        font-size: 20px;
      }
      body {
        font-family: "Courier New", monospace;
        background-color: Canvas;
      }
      .section {
        margin-bottom: 30px;
      }
      a {
        color: inherit;
        word-break: break-all;
      }
      .hidden {
        display: none;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        border: 1px solid currentColor;
        padding: 0.5ch 1ch;
      }
    </style>
  </head>
  <body>
    <div id="authSection" class="section">
      <button id="signInBtn">Sign in with Google</button>
    </div>

    <div id="appSection">
      <div class="section">
        <div>User: <span id="userEmail">-</span></div>
        <button id="signOutBtn" class="hidden">Sign out</button>
      </div>

      <div class="section">
        <form id="ipForm">
          <input type="text" id="ipInput" placeholder="192.168.0.0" required />
          <button type="submit" id="submitBtn" disabled>Submit</button>
        </form>
      </div>

      <div class="section">
        <div>Current IP: <span id="currentIp">-</span></div>
        <div>Modified by: <span id="modifiedBy">-</span></div>
      </div>

      <div class="section">
        <div>Endpoint: <a id="getUrl" href="" target="_blank">-</a></div>
      </div>

      <div class="section">
        <div style="margin-bottom: 15px">
          <div>Get IP in Windows (PowerShell):</div>
          <pre>
powershell -Command "(Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike '*Loopback*'} | Select-Object -First 1).IPAddress"</pre
          >
        </div>
        <div>
          <div>Get IP in Mac/Linux (Bash):</div>
          <pre>hostname -I | awk '{print $1}' || ifconfig | grep -A1 "en0\|eth0" | grep "inet " | awk '{print $2}' | sed 's/addr://'</pre>
        </div>
      </div>

      <div class="section">
        <a href="https://gitlab.cba.mit.edu/classes/863.25/CBA/cba-machine/-/tree/main/public/labubu-api" target="_blank">Source code and documentation</a>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
      import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAjFJZ5BQk7FTPojGz9BfaXAOmfXxyRg1k",
        authDomain: "htmaa-25-labubu.firebaseapp.com",
        databaseURL: "https://htmaa-25-labubu-default-rtdb.firebaseio.com",
        projectId: "htmaa-25-labubu",
        storageBucket: "htmaa-25-labubu.firebasestorage.app",
        messagingSenderId: "173460075430",
        appId: "1:173460075430:web:06f7c77fefe22f0b319567",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();
      const configRef = ref(db, "config");
      const metadataRef = ref(db, "metadata");

      const authSection = document.getElementById("authSection");
      const appSection = document.getElementById("appSection");
      const signInBtn = document.getElementById("signInBtn");
      const signOutBtn = document.getElementById("signOutBtn");
      const userEmail = document.getElementById("userEmail");
      const submitBtn = document.getElementById("submitBtn");

      let currentUser = null;

      const getUrl = `${firebaseConfig.databaseURL}/config.json`;
      const urlElement = document.getElementById("getUrl");
      urlElement.textContent = getUrl;
      urlElement.href = getUrl;

      signInBtn.addEventListener("click", () => {
        signInWithPopup(auth, provider).catch((error) => {
          console.error("Sign in error:", error);
        });
      });

      signOutBtn.addEventListener("click", () => {
        signOut(auth);
      });

      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
          authSection.classList.add("hidden");
          userEmail.textContent = user.email;
          signOutBtn.classList.remove("hidden");
          submitBtn.disabled = false;
        } else {
          authSection.classList.remove("hidden");
          userEmail.textContent = "-";
          signOutBtn.classList.add("hidden");
          submitBtn.disabled = true;
        }
      });

      document.getElementById("ipForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const ip = document.getElementById("ipInput").value;
        set(configRef, { ip: ip });
        set(metadataRef, { modifiedBy: currentUser.email, modifiedAt: new Date().toISOString() });
        document.getElementById("ipInput").value = "";
      });

      onValue(configRef, (snapshot) => {
        const data = snapshot.val();
        const ip = data ? data.ip : "-";
        document.getElementById("currentIp").textContent = ip;
      });

      onValue(metadataRef, (snapshot) => {
        const data = snapshot.val();
        const modifiedBy = data ? data.modifiedBy : "-";
        document.getElementById("modifiedBy").textContent = modifiedBy;
      });
    </script>
  </body>
</html>

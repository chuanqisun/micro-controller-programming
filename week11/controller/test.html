<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Bluetooth Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
            background-color: #f0f0f0;
        }
        #messages {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .info {
            color: blue;
        }
    </style>
</head>
<body>
    <h1>ESP32 Bluetooth Connection Test</h1>
    
    <button id="connectBtn" onclick="connectESP32()">Connect to ESP32</button>
    <button id="disconnectBtn" onclick="disconnectESP32()" disabled>Disconnect</button>
    <button id="sendBtn" onclick="sendCommand()" disabled>Send 'b' Command</button>
    
    <div id="status">Ready to connect. Click the button above to start.</div>
    
    <h2>Received Messages:</h2>
    <div id="messages"></div>

    <script src="esp32_bluetooth.js"></script>
    <script>
        let device = null;
        let server = null;
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = type;
        }

        function addMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            messagesDiv.textContent += `[${timestamp}] ${message}\n`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Override the connectESP32 function to add UI updates
        const originalConnectESP32 = connectESP32;
        async function connectESP32() {
            try {
                updateStatus('Requesting device...', 'info');
                connectBtn.disabled = true;

                // Check if Web Bluetooth is supported
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth API is not supported in this browser. Use Chrome, Edge, or Opera.');
                }

                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                
                updateStatus('Connecting to device...', 'info');
                addMessage(`Connecting to device: ${device.name || 'Unknown'}`);
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                // Get TX characteristic for receiving notifications
                window.charRx = await service.getCharacteristic(TX_CHAR_UUID);
                charRx = window.charRx;
                
                // Get RX characteristic for sending data
                window.charTx = await service.getCharacteristic(RX_CHAR_UUID);
                charTx = window.charTx;

                // Store references for disconnection
                window.bluetoothDevice = device;
                window.bluetoothServer = server;

                // Receive notifications
                await charRx.startNotifications();
                charRx.addEventListener('characteristicvaluechanged', (e) => {
                    const v = e.target.value;
                    const text = new TextDecoder().decode(v.buffer);
                    addMessage(`ESP32> ${text}`);
                    console.log('ESP32>', text);
                    
                    // Check if this is an acknowledgement for "b" command
                    if (text.includes('ACK: b') || text.includes('Received: b')) {
                        updateStatus('Command acknowledged by ESP32!', 'success');
                    }
                });

                updateStatus('Connected! Listening for messages...', 'success');
                addMessage('Connection established. Waiting for data...');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;

                // Handle disconnection
                device.addEventListener('gattserverdisconnected', () => {
                    updateStatus('Device disconnected', 'error');
                    addMessage('Device disconnected');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                });

            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                addMessage(`ERROR: ${error.message}`);
                console.error('Connection error:', error);
                connectBtn.disabled = false;
                sendBtn.disabled = true;
            }
        }

        async function sendCommand() {
            try {
                sendBtn.disabled = true;
                addMessage('Browser> Sending "b" command...');
                await sendToESP32('b');
                addMessage('Browser> Command "b" sent successfully');
                sendBtn.disabled = false;
            } catch (error) {
                updateStatus(`Send error: ${error.message}`, 'error');
                addMessage(`ERROR sending command: ${error.message}`);
                console.error('Send error:', error);
                sendBtn.disabled = false;
            }
        }

        async function disconnectESP32() {
            try {
                if (window.bluetoothDevice && window.bluetoothDevice.gatt.connected) {
                    window.bluetoothDevice.gatt.disconnect();
                    updateStatus('Disconnected', 'info');
                    addMessage('Disconnected by user');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                }
            } catch (error) {
                updateStatus(`Disconnect error: ${error.message}`, 'error');
                console.error('Disconnect error:', error);
            }
        }
    </script>
</body>
</html>


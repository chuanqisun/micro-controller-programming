<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 LED Control</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin: 20px 0;
      }
      button {
        padding: 15px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .status {
        margin: 20px 0;
        padding: 10px;
        border-radius: 5px;
        background: #f8f9fa;
      }
      .log {
        margin-top: 20px;
        padding: 10px;
        background: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>ESP32 LED Control</h1>

    <div class="status">Status: <span id="status">Not connected</span></div>

    <button id="connectBtn">Connect BLE</button>
    <button id="disconnectBtn" disabled>Disconnect</button>

    <div class="controls">
      <button id="led0" disabled>Blink LED 0</button>
      <button id="led1" disabled>Blink LED 1</button>
      <button id="led2" disabled>Blink LED 2</button>
      <button id="led3" disabled>Blink LED 3</button>
      <button id="led4" disabled>Blink LED 4</button>
      <button id="led5" disabled>Blink LED 5</button>
      <button id="led6" disabled>Blink LED 6</button>
      <button id="led7" disabled>Blink LED 7</button>
    </div>

    <div class="log" id="log"></div>

    <script>
      const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
      const TX_CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
      const RX_CHAR_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

      let device = null;
      let charTx = null;
      let charRx = null;

      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const statusSpan = document.getElementById("status");
      const logDiv = document.getElementById("log");

      function log(msg) {
        const timestamp = new Date().toISOString().substring(11, 23);
        logDiv.textContent += `[${timestamp}] ${msg}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      connectBtn.addEventListener("click", async () => {
        try {
          if (!navigator.bluetooth) {
            throw new Error("Web Bluetooth not supported");
          }

          log("Requesting BLE device...");
          device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [SERVICE_UUID] }],
          });

          log(`Connecting to ${device.name || "device"}...`);
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(SERVICE_UUID);

          charRx = await service.getCharacteristic(TX_CHAR_UUID);
          charTx = await service.getCharacteristic(RX_CHAR_UUID);

          await charRx.startNotifications();
          charRx.addEventListener("characteristicvaluechanged", (e) => {
            const text = new TextDecoder().decode(e.target.value.buffer);
            log(`RX: ${text}`);
          });

          device.addEventListener("gattserverdisconnected", () => {
            log("Device disconnected");
            statusSpan.textContent = "Disconnected";
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            disableLedButtons();
          });

          log("Connected");
          statusSpan.textContent = "Connected";
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          enableLedButtons();
        } catch (error) {
          log(`ERROR: ${error.message}`);
          console.error(error);
        }
      });

      disconnectBtn.addEventListener("click", () => {
        if (device && device.gatt.connected) {
          device.gatt.disconnect();
          log("Disconnected by user");
          statusSpan.textContent = "Disconnected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          disableLedButtons();
        }
      });

      function enableLedButtons() {
        for (let i = 0; i < 8; i++) {
          document.getElementById(`led${i}`).disabled = false;
        }
      }

      function disableLedButtons() {
        for (let i = 0; i < 8; i++) {
          document.getElementById(`led${i}`).disabled = true;
        }
      }

      for (let i = 0; i < 8; i++) {
        document.getElementById(`led${i}`).addEventListener("click", async () => {
          try {
            const command = `blink:${i}`;
            const encoder = new TextEncoder();
            const data = encoder.encode(command);
            await charTx.writeValue(data);
            log(`TX: ${command}`);
          } catch (error) {
            log(`ERROR: ${error.message}`);
          }
        });
      }
    </script>
  </body>
</html>

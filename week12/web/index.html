<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 LED Control</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin: 20px 0;
      }
      button {
        padding: 15px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .status {
        margin: 20px 0;
        padding: 10px;
        border-radius: 5px;
        background: #f8f9fa;
      }
      .log {
        margin-top: 20px;
        padding: 10px;
        background: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>ESP32 LED Control & Probe Display</h1>

    <h2>Switchboard (LED Control)</h2>
    <div class="status">Status: <span id="statusSw">Not connected</span></div>

    <button id="connectBtnSw">Connect Switchboard BLE</button>
    <button id="disconnectBtnSw" disabled>Disconnect</button>

    <div class="controls">
      <button id="led0" disabled>Blink LED 0</button>
      <button id="led1" disabled>Blink LED 1</button>
      <button id="led2" disabled>Blink LED 2</button>
      <button id="led3" disabled>Blink LED 3</button>
      <button id="led4" disabled>Blink LED 4</button>
      <button id="led5" disabled>Blink LED 5</button>
      <button id="led6" disabled>Blink LED 6</button>
      <button id="led7" disabled>Blink LED 7</button>
    </div>

    <h2>Operator (Probe Display)</h2>
    <div class="status">Status: <span id="statusOp">Not connected</span></div>

    <button id="connectBtnOp">Connect Operator BLE</button>
    <button id="disconnectBtnOp" disabled>Disconnect</button>

    <div id="probeDisplay">Probe: <span id="probeValue">---</span></div>

    <div class="log" id="log"></div>

    <script>
      const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
      const TX_CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
      const RX_CHAR_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

      // Switchboard variables
      let deviceSw = null;
      let charTxSw = null;
      let charRxSw = null;

      // Operator variables
      let deviceOp = null;
      let charTxOp = null;
      let charRxOp = null;

      const connectBtnSw = document.getElementById("connectBtnSw");
      const disconnectBtnSw = document.getElementById("disconnectBtnSw");
      const statusSpanSw = document.getElementById("statusSw");

      const connectBtnOp = document.getElementById("connectBtnOp");
      const disconnectBtnOp = document.getElementById("disconnectBtnOp");
      const statusSpanOp = document.getElementById("statusOp");

      const logDiv = document.getElementById("log");

      function log(msg) {
        const timestamp = new Date().toISOString().substring(11, 23);
        logDiv.textContent += `[${timestamp}] ${msg}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // Connect Switchboard
      connectBtnSw.addEventListener("click", async () => {
        try {
          if (!navigator.bluetooth) {
            throw new Error("Web Bluetooth not supported");
          }

          log("Requesting Switchboard BLE device...");
          deviceSw = await navigator.bluetooth.requestDevice({
            filters: [{ name: "Switchboard" }],
            optionalServices: [SERVICE_UUID],
          });

          log(`Connecting to ${deviceSw.name || "device"}...`);
          const server = await deviceSw.gatt.connect();
          const service = await server.getPrimaryService(SERVICE_UUID);

          charRxSw = await service.getCharacteristic(TX_CHAR_UUID);
          charTxSw = await service.getCharacteristic(RX_CHAR_UUID);

          await charRxSw.startNotifications();
          charRxSw.addEventListener("characteristicvaluechanged", (e) => {
            const text = new TextDecoder().decode(e.target.value.buffer);
            log(`Switchboard RX: ${text}`);
          });

          deviceSw.addEventListener("gattserverdisconnected", () => {
            log("Switchboard disconnected");
            statusSpanSw.textContent = "Disconnected";
            connectBtnSw.disabled = false;
            disconnectBtnSw.disabled = true;
            disableLedButtons();
          });

          log("Switchboard connected");
          statusSpanSw.textContent = "Connected";
          connectBtnSw.disabled = true;
          disconnectBtnSw.disabled = false;
          enableLedButtons();
        } catch (error) {
          log(`ERROR: ${error.message}`);
          console.error(error);
        }
      });

      // Disconnect Switchboard
      disconnectBtnSw.addEventListener("click", () => {
        if (deviceSw && deviceSw.gatt.connected) {
          deviceSw.gatt.disconnect();
          log("Switchboard disconnected by user");
          statusSpanSw.textContent = "Disconnected";
          connectBtnSw.disabled = false;
          disconnectBtnSw.disabled = true;
          disableLedButtons();
        }
      });

      // Connect Operator
      connectBtnOp.addEventListener("click", async () => {
        try {
          if (!navigator.bluetooth) {
            throw new Error("Web Bluetooth not supported");
          }

          log("Requesting Operator BLE device...");
          deviceOp = await navigator.bluetooth.requestDevice({
            filters: [{ name: "Operator" }],
            optionalServices: [SERVICE_UUID],
          });

          log(`Connecting to ${deviceOp.name || "device"}...`);
          const server = await deviceOp.gatt.connect();
          const service = await server.getPrimaryService(SERVICE_UUID);

          charRxOp = await service.getCharacteristic(TX_CHAR_UUID);

          await charRxOp.startNotifications();
          charRxOp.addEventListener("characteristicvaluechanged", (e) => {
            const text = new TextDecoder().decode(e.target.value.buffer);
            log(`Operator RX: ${text}`);
            document.getElementById("probeValue").textContent = text.trim();
          });

          deviceOp.addEventListener("gattserverdisconnected", () => {
            log("Operator disconnected");
            statusSpanOp.textContent = "Disconnected";
            connectBtnOp.disabled = false;
            disconnectBtnOp.disabled = true;
          });

          log("Operator connected");
          statusSpanOp.textContent = "Connected";
          connectBtnOp.disabled = true;
          disconnectBtnOp.disabled = false;
        } catch (error) {
          log(`ERROR: ${error.message}`);
          console.error(error);
        }
      });

      // Disconnect Operator
      disconnectBtnOp.addEventListener("click", () => {
        if (deviceOp && deviceOp.gatt.connected) {
          deviceOp.gatt.disconnect();
          log("Operator disconnected by user");
          statusSpanOp.textContent = "Disconnected";
          connectBtnOp.disabled = false;
          disconnectBtnOp.disabled = true;
        }
      });

      function enableLedButtons() {
        for (let i = 0; i < 8; i++) {
          document.getElementById(`led${i}`).disabled = false;
        }
      }

      function disableLedButtons() {
        for (let i = 0; i < 8; i++) {
          document.getElementById(`led${i}`).disabled = true;
        }
      }

      for (let i = 0; i < 8; i++) {
        document.getElementById(`led${i}`).addEventListener("click", async () => {
          try {
            const command = `blink:${i}`;
            const encoder = new TextEncoder();
            const data = encoder.encode(command);
            await charTxSw.writeValue(data);
            log(`Switchboard TX: ${command}`);
          } catch (error) {
            log(`ERROR: ${error.message}`);
          }
        });
      }
    </script>
  </body>
</html>
